<aside class="page-sidebar">
  <!-- Home page: Show all classes with collapsible sections -->
  {% if page.layout == 'home' %}
    <h3>Course Navigation</h3>
    <nav class="sidebar-nav">
      {% for class in site.data.navigation.classes %}
        <div class="sidebar-section">
          <h4 class="collapsible-header" onclick="toggleSection('class-{{ class.number }}')">
            <span>Class {{ class.number }}: {{ class.title }}</span>
            <span class="toggle-icon">+</span>
          </h4>
          <div class="collapsible-content" id="class-{{ class.number }}">
            {% if class.lessons %}
              <div class="content-group">
                <span class="group-label">Lessons</span>
                <ul class="sidebar-list">
                  {% for lesson in class.lessons %}
                    <li><a href="{{ lesson.path | relative_url }}">{{ lesson.title }}</a></li>
                  {% endfor %}
                </ul>
              </div>
            {% endif %}
            {% if class.code_examples %}
              <div class="content-group">
                <span class="group-label">Code Examples</span>
                <ul class="sidebar-list">
                  {% for example in class.code_examples %}
                    <li><a href="{{ example.path | relative_url }}">{{ example.title }}</a></li>
                  {% endfor %}
                </ul>
              </div>
            {% endif %}
            {% if class.exercises %}
              <div class="content-group">
                <span class="group-label">Exercises</span>
                <ul class="sidebar-list">
                  {% for exercise in class.exercises %}
                    <li><a href="{{ exercise.path | relative_url }}">{{ exercise.title }}</a></li>
                  {% endfor %}
                </ul>
              </div>
            {% endif %}
          </div>
        </div>
      {% endfor %}
    </nav>

  <!-- Lesson/Exercise pages: Show current class content -->
  {% else %}
    {% comment %} Find which class this page belongs to {% endcomment %}
    {% assign current_class = null %}
    {% assign page_url = page.url | remove: '.html' %}

    {% for class in site.data.navigation.classes %}
      {% comment %} Check lessons {% endcomment %}
      {% for lesson in class.lessons %}
        {% if lesson.path == page_url or page_url contains lesson.path %}
          {% assign current_class = class %}
          {% break %}
        {% endif %}
      {% endfor %}
      {% if current_class %}{% break %}{% endif %}

      {% comment %} Check exercises {% endcomment %}
      {% for exercise in class.exercises %}
        {% if exercise.path == page_url or page_url contains exercise.path %}
          {% assign current_class = class %}
          {% break %}
        {% endif %}
      {% endfor %}
      {% if current_class %}{% break %}{% endif %}

      {% comment %} Check code examples {% endcomment %}
      {% if class.code_examples %}
        {% for example in class.code_examples %}
          {% if example.path == page_url or page_url contains example.path %}
            {% assign current_class = class %}
            {% break %}
          {% endif %}
        {% endfor %}
      {% endif %}
      {% if current_class %}{% break %}{% endif %}
    {% endfor %}

    {% comment %} Fallback: Try to find by class_number variable {% endcomment %}
    {% unless current_class %}
      {% if page.class_number %}
        {% for class in site.data.navigation.classes %}
          {% if class.number == page.class_number %}
            {% assign current_class = class %}
            {% break %}
          {% endif %}
        {% endfor %}
      {% endif %}
    {% endunless %}

    {% if current_class %}
      <h3>Class {{ current_class.number }}: {{ current_class.title }}</h3>
      <nav class="sidebar-nav">
        {% if current_class.lessons %}
          <div class="sidebar-section">
            <h4 class="collapsible-header" onclick="toggleSection('lessons-section')">
              <span>Lessons</span>
              <span class="toggle-icon">+</span>
            </h4>
            <div class="collapsible-content open" id="lessons-section">
              <ul class="sidebar-list">
                {% for lesson in current_class.lessons %}
                  {% assign is_current = false %}
                  {% if lesson.path == page_url or page_url contains lesson.path %}
                    {% assign is_current = true %}
                  {% endif %}
                  <li class="{% if is_current %}current{% endif %}">
                    <a href="{{ lesson.path | relative_url }}">{{ lesson.title }}</a>
                  </li>
                {% endfor %}
              </ul>
            </div>
          </div>
        {% endif %}

        {% if current_class.code_examples %}
          <div class="sidebar-section">
            <h4 class="collapsible-header" onclick="toggleSection('code-examples-section')">
              <span>Code Examples</span>
              <span class="toggle-icon">+</span>
            </h4>
            <div class="collapsible-content" id="code-examples-section">
              <ul class="sidebar-list">
                {% for example in current_class.code_examples %}
                  {% assign is_current = false %}
                  {% if example.path == page_url or page_url contains example.path %}
                    {% assign is_current = true %}
                  {% endif %}
                  <li class="{% if is_current %}current{% endif %}">
                    <a href="{{ example.path | relative_url }}">{{ example.title }}</a>
                  </li>
                {% endfor %}
              </ul>
            </div>
          </div>
        {% endif %}

        {% if current_class.exercises %}
          <div class="sidebar-section">
            <h4 class="collapsible-header" onclick="toggleSection('exercises-section')">
              <span>Exercises</span>
              <span class="toggle-icon">+</span>
            </h4>
            <div class="collapsible-content" id="exercises-section">
              <ul class="sidebar-list">
                {% for exercise in current_class.exercises %}
                  {% assign is_current = false %}
                  {% if exercise.path == page_url or page_url contains exercise.path %}
                    {% assign is_current = true %}
                  {% endif %}
                  <li class="{% if is_current %}current{% endif %}">
                    <a href="{{ exercise.path | relative_url }}">{{ exercise.title }}</a>
                  </li>
                {% endfor %}
              </ul>
            </div>
          </div>
        {% endif %}
      </nav>
    {% else %}
      <!-- Fallback: Show basic navigation if class can't be determined -->
      <h3>Course Navigation</h3>
      <nav class="sidebar-nav">
        <div class="sidebar-section">
          <ul class="sidebar-list">
            <li><a href="{{ '/' | relative_url }}">‚Üê Back to Home</a></li>
          </ul>
        </div>
      </nav>
    {% endif %}
  {% endif %}
</aside>